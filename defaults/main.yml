---
tmpfs: /tmp/chroot_tmpfs

chroot: "{{ tmpfs }}/merge"
workfs: "{{ tmpfs }}/work"
topfs: "{{ tmpfs }}/top"

bootstrap_chroot_apk:
  - python3

bootstrap_chroot_yum:
  - python3

bootstrap_chroot_apt:
  - python3-minimal
  - python3-apt

bootstrap_chroot_raw:
  - mkdir -p {{ tmpfs }}
  - mount -t tmpfs tmpfs {{ tmpfs }}
  - mkdir -p {{ topfs }} {{ chroot }} {{ workfs }}
  - mount -t overlay overlay -o lowerdir=/,upperdir={{ topfs }},workdir={{ workfs }} {{ chroot }}
  - mount --rbind /dev {{ chroot }}/dev
  - mount --rbind /etc/resolv.conf {{ chroot }}/etc/resolv.conf
  - test $(command -v apk) && chroot {{ chroot }} sh -c 'apk add {{ bootstrap_chroot_apk | join(' ') }}' || true
  - test $(command -v yum) && chroot {{ chroot }} yum install -y {{ bootstrap_chroot_yum | join(' ') }} || true 
  - test $(command -v apt-get) && chroot {{ chroot }} sh -c 'apt-get update && apt-get install -y {{ bootstrap_chroot_apt | join(' ') }}' || true